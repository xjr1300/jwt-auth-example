# JWT-Auth

- JWTトークンでユーザーを認証することを試行したサンプルアプリケーション
- クッキーでトークンを送受信するため、HTTPSで運用することを前提

## 仕様

### ユーザークレデンシャル

- ユーザーの識別にEメールアドレスを使用
- ユーザークレデンシャルに、Eメールアドレスとパスワードを使用
- パスワードにはユーザーごとに別のソルトを付与
- ソルトを付与したパスワードを、システム固定の秘密鍵(SECRET_KEY)で暗号化して保存

### クッキー

- クッキーの有効期限はブラウザセッション
 
### トークンの管理

- アクセストークンは、有効期限を設定してredisに管理
- アクセストークンの有効期限は10分
- リフレッシュトークンは有効期限を設定してデータベースに蓄積
- リフレッシュトークンの有効期限は60分
- 各トークンには、UUIDで生成されたユーザーIDを記録
- 有効期限の切れたリフレッシュトークンを削除するバックグラウンドプロセスが必要

### ブラウザによるトークンの送信

- クッキーは`HttpOnly`を設定するため、JavaScriptでクッキーにアクセスできない
- よって、セッションを継続するために、アクセストークンとリフレッシュトークン双方をクッキーで送信
 
### ユーザー認証

1. SPAアプリが、Eメールアドレスとパスワードを送信して、ユーザーの認証を試行
2. サーバーは、ユーザーが認証に成功したら・・・
  - ユーザーをデータベースから取得して、ユーザーが有効か確認
    - ユーザーが無効な場合、サーバーはSPAアプリに`401 Unauthorized`でレスポンス
  - セッションID、アクセストークンとリフレッシュトークンを生成
    - 当該ユーザーのユーザーIDを記録
  - サーバーは、セッションIDとアクセストークンを、有効期限付きでredisに登録
  - サーバーは、セッションIDとリフレッシュトークンを、有効期限付きでデータベースに登録
  - サーバーは、ブラウザに認証に成功したことを応答するとともに、セッションID、アクセストークン及びリフレッシュトークンをクッキーに保存するように指示
    - HttpOnly: true
      - JavaScriptからクッキーにアクセスできない
    - SameSite: Lax
      - 他のサイトからシステムへのPOSTリクエストで、クッキーが送信されない
    - Secure: true
      - HTTPSのみクッキーを送信
    - アクセストークンとリフレッシュトークンには、redisまたはデータベースに格納したときに設定した、同じ有効期限を設定
3. サーバーは、ユーザーが認証に失敗した場合、成功したら・・・
  - サーバーは、SPAアプリに`401 Unauthorized`でレスポンス
  - SPAアプリは、認証ページを表示

### 保護されたAPIへのアクセス

#### アクセストークンが有効の場合

1. SPAアプリが、保護されたAPIをリクエスト
  - ブラウザが、クッキーでセッションID、アクセストークンとリクエストトークンをサーバーに送信
2. サーバーは、ブラウザが送信したクッキーに記録されたセッションIDをキーにredisからアクセストークンを取得
3. サーバーは、上記で取得したアクセストークンとブラウザが送信したアクセストークンを比較
4. アクセストークンが一致した場合
  - サーバーは、ユーザーをデータベースから取得して、ユーザーが有効か確認
    - ユーザーが無効な場合、サーバーはSPAアプリに`401 Unauthorized`でレスポンス
  - サーバーは、保護されたAPIのリクエストを処理
5. アクセストークンが異なる場合
  - サーバーは、SPAアプリに`401 Unauthorized`でレスポンス
  - SPAアプリは、認証ページを表示

#### アクセストークンが失効して、リフレッシュトークンが有効な場合

1. SPAアプリが、保護されたAPIをリクエスト
2. サーバーは、ブラウザが送信したクッキーに記録されたセッションIDをキーにredisからアクセストークンの取得を試行
  - 有効期限切れのため、アクセストークンをredisから取得できない
3. サーバーは、ブラウザが送信したクッキーに記録されたセッションIDをキーにデータベースからリフレッシュトークンを取得
4. サーバーは、上記で取得したリフレッシュトークンとブラウザが送信したリフレッシュトークンを比較
5. リフレッシュトークンが一致する場合
  - サーバーは、ユーザーをデータベースから取得して、ユーザーが有効か確認
    - ユーザーが無効な場合、サーバーはSPAアプリに`401 Unauthorized`でレスポンス
  - 認証処理の2を実施
  - 保護されたAPIのリクエストを処理
6. リフレッシュトークンが異なる場合
  - サーバーは、SPAアプリに`401 Unauthorized`でレスポンス
  - SPAアプリは、認証ページを表示

#### アクセストークンとリフレッシュトークン双方がが失効した場合

1. SPAアプリが、保護されたAPIをリクエスト
2. サーバーは、ブラウザが送信したクッキーに記録されたセッションIDをキーにredisからアクセストークンの取得を試行
  - 有効期限切れのため、アクセストークンをredisから取得できない
3. サーバーは、ブラウザが送信したクッキーに記録されたセッションIDをキーにデータベースからリフレッシュトークンの取得を試行
  - 有効期限切れのため、リフレッシュトークンをredisから取得できない
4. サーバーは、SPAアプリに`401 Unauthorized`でレスポンス
  - SPAアプリは、認証ページを表示

### パスワード変更

1. SPAアプリが、パスワード変更APIをリクエスト
2. サーバーは、ユーザーのパスワードを変更
3. サーバーは、当該セッションのセッションIDと関連する各トークンをredisまたはデータベースから削除
4. サーバーは、SPAアプリに`200 OK`でレスポンス
  - サーバーは、ブラウザにセッションID、アクセストークン及びリフレッシュトークンの有効期限を過去に変更するように指示
    - これらのクッキーが無効になる
5. SPAアプリは、ログアウト状態に移行

### ログアウト

1. SPAアプリが、ログアウトAPIをリクエスト
2. サーバーは、当該セッションのセッションIDと関連する各トークンをredisまたはデータベースから削除
3. サーバーは、SPAアプリに`200 OK`でレスポンス
  - サーバーは、ブラウザにセッションID、アクセストークン及びリフレッシュトークンの有効期限を過去に変更するように指示
    - これらのクッキーが無効になる
4. SPAアプリは、ログアウト状態に移行

## テスト

### 単体テスト

単体テスト以下の通り実行する。
統合テストには、`ignore`属性を付与しているため、統合テストは実行されない。

```bash
cargo test
```

### 統合テスト

統合テストは以下の通り実行する。

```bash
cargo test -- --ignored
```
